{% extends 'ecoApp/base.html' %}

{% block content %}
{% load static %}

<div class="initial-content" style="margin-top: 60px;"> 
    <h2>REQUESTS IN PROGRESS</h2>
    <div class="welcome-user">
        <h5>Confirm your requests here!</h5>
    </div>  
</div>




{% if session_items %}
<div class="row justify-content-center mt-4">
    <div class="col-md-7">   
        <div class="row justify-content-center">
            <div class="col-md-9">
                {% for item in session_items %}
                    <div class="request-container mb-4">
                        {% if item.category == 'Electronic device' %}
                            <div class="requests-cards" data-index="{{ forloop.counter0 }}">
                                <div class="card-body">
                                    <h2 class="card-title mb-4">{{ item.name }}</h2>
                                    <div class="row">
                                        <div class="col-md-4 " style="border-right: 1px solid #ccc;">
                                            <p><strong>Units:</strong> {{ item.units }} </p>
                                            <p><strong>Points:</strong> {{ item.points }}</p>
                                            <p><strong>Category:</strong> {{ item.category }}</p>
                                            <p><strong>Brand:</strong> {{ item.brand }}</p>
                                            <p><strong>Status:</strong> {{ item.status }}</p>
                                        </div>
                                        <div class="col-md-6" style="margin-left: 30px;">
                                            <p><strong>Observations:</strong></p>
                                            <p>{{ item.observations }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer d-flex justify-content-end">
                                    <form action="{% url 'requests' %}" method="post">
                                        {% csrf_token %}
                                        <input  type="hidden" name="delete_item_index" value="{{ forloop.counter0 }}">
                                        <button type="submit" class="btn btn-danger delete-btn">Delete</button> 
                                    </form>
                                </div>                                
                            </div>                            
                        {% endif %}

                        {% if item.category == 'Appliance' %}
                            <div class="requests-cards" data-index="{{ forloop.counter0 }}">
                                <div class="card-body">
                                    <h2 class="card-title mb-4">{{ item.name }}</h2>
                                    <div class="row">
                                        <div class="col-md-4" style="border-right: 1px solid #ccc;">                                            
                                            <p><strong>Units:</strong> {{ item.units }}</p>
                                            <p><strong>Points:</strong> {{ item.points }}</p>
                                            <p><strong>Category:</strong> {{ item.category }}</p>
                                            <p><strong>Brand:</strong> {{ item.brand }}</p>
                                            <p><strong>Status:</strong> {{ item.status }}</p>
                                            <p><strong>Weight:</strong> {{ item.weight }} kg</p>                                    
                                            <p><strong>Dimensions:</strong> {{ item.length }}cm x {{ item.width }}cm x {{ item.depth }}cm</p>
                                        </div>
                                        <div class="col-md-6" style="margin-left: 30px;">                                            
                                            <p><strong>Observations:</strong></p>
                                            <p>{{ item.observations }}</p>
                                        </div>
                                    </div>    
                                </div>
                                <div class="card-footer d-flex justify-content-end">
                                    <form action="{% url 'requests' %}" method="post">
                                        {% csrf_token %}
                                        <input  type="hidden" name="delete_item_index" value="{{ forloop.counter0 }}">
                                        <button type="submit" class="btn btn-danger delete-btn">Delete</button> 
                                    </form>
                                </div>
                            </div>
                            
                        {% endif %}
                    </div>
                {% endfor %}
                </div>
        </div>
    </div>
    <div class="col-md-3 ">        
        <div class="total-requests-card mb-4 ">
            <h2>Total Request</h2>
            <div class="card-body">                
                <p>Total Points: <span id="total-points" class="points-total">0</span></p>                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="home-delivery" onchange="dateInput()">
                    <label class="form-check-label" for="home-delivery">Home pickup</label>
                </div>      
                <div id="date-input-container" style="display: none;">
                    <label for="delivery-date">Select pickup date:</label>
                    <input type="date" id="delivery-date" name="delivery_date">
                </div>          
                <button class="btn btn-primary mt-2" id="send-request-btn">Send Request</button>
            </div>
        </div>
    </div>    
</div>
{% else %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert" style="width: 25vw !important; margin-left: 30px !important; margin-right: -15px !important;">
        You haven't made requests yet.       
    </div>
{% endif %}

<script>    
    function calcularPuntosTotales() {
        var totalPuntos = 0;        
        var solicitudes = document.querySelectorAll('.request-container');       
        var unidades, puntos;
        
        solicitudes.forEach(function(solicitud) {            
            var elementosP = solicitud.querySelectorAll('p');  

            elementosP.forEach(function(elemento) {                
                if (elemento.textContent.includes("Units")) {
                    unidades = parseInt(elemento.textContent.split(":")[1].trim());
                }
                if (elemento.textContent.includes("Points")) {
                    puntos = parseInt(elemento.textContent.split(":")[1].trim());
                }
            });            
            if (!isNaN(unidades) && !isNaN(puntos)) {
                totalPuntos += unidades * puntos;
            }
        });       
        document.getElementById('total-points').textContent = totalPuntos;
    }   


    function dateInput() {
        var checkBox = document.getElementById('home-delivery');
        var dateInputContainer = document.getElementById('date-input-container');
        if (checkBox.checked) {
            dateInputContainer.style.display = 'block';
        } else {
            dateInputContainer.style.display = 'none';
        }
    }

    window.onload = function() {
        calcularPuntosTotales();
    };
    

</script>





{% endblock %}
